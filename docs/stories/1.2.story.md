# Story 1.2: Configure Supabase Integration

## Status
Approved

## Story
**As a** developer,
**I want** to configure Supabase integration with authentication setup,
**so that** we have a secure backend infrastructure for user management and data storage

## Acceptance Criteria
1. Supabase project is created and configured with proper environment variables
2. Supabase client is initialized with TypeScript types
3. Authentication helpers are implemented for both client and server-side
4. Basic auth middleware is created for protecting API routes
5. User profile table and RLS policies are configured
6. Development and production environment configurations are separated
7. Authentication flow can be tested with a simple login/logout

## Tasks / Subtasks
- [ ] Set up Supabase project (AC: 1)
  - [ ] Create new Supabase project via dashboard
  - [ ] Obtain project URL and anon/service keys
  - [ ] Add Supabase credentials to .env.local
- [ ] Install and configure Supabase client (AC: 2)
  - [ ] Install @supabase/supabase-js and @supabase/auth-helpers-nextjs
  - [ ] Create lib/supabase/client.ts for client-side initialization
  - [ ] Create lib/supabase/server.ts for server-side initialization
  - [ ] Generate TypeScript types from Supabase schema
- [ ] Implement authentication helpers (AC: 3)
  - [ ] Create auth context provider for client components
  - [ ] Implement useAuth hook for accessing auth state
  - [ ] Set up auth state persistence and refresh
- [ ] Create auth middleware (AC: 4)
  - [ ] Implement withAuth middleware for API route protection
  - [ ] Add user session validation helpers
  - [ ] Create role-based authorization helpers (for future admin features)
- [ ] Configure database schema (AC: 5)
  - [ ] Create users table extending Supabase auth.users
  - [ ] Add user_profiles table with business-specific fields
  - [ ] Set up Row Level Security (RLS) policies
  - [ ] Create initial migration files
- [ ] Set up environment configuration (AC: 6)
  - [ ] Configure Supabase client for different environments
  - [ ] Add type-safe environment variable access
  - [ ] Update .env.example with all Supabase variables
- [ ] Create auth test pages (AC: 7)
  - [ ] Build simple login/signup test page
  - [ ] Add logout functionality
  - [ ] Verify auth state persistence

## Dev Notes
### Supabase Configuration
[Source: architecture/6-external-api-integrations.md#supabase-integration]

Required environment variables:
```
NEXT_PUBLIC_SUPABASE_URL=your_project_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

### File Structure
```
lib/
├── supabase/
│   ├── client.ts         # Client-side Supabase client
│   ├── server.ts         # Server-side Supabase client
│   ├── auth-helpers.ts   # Authentication utilities
│   └── types.ts          # Generated TypeScript types
├── auth/
│   ├── context.tsx       # Auth context provider
│   └── hooks.ts          # useAuth and other auth hooks
```

### Database Schema
[Source: architecture/8-database-schema.md]

Initial tables to create:
```sql
-- User profiles extending auth.users
CREATE TABLE user_profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT UNIQUE NOT NULL,
  full_name TEXT,
  company_name TEXT,
  industry TEXT,
  role TEXT DEFAULT 'user',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Enable RLS
ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;

-- RLS Policy: Users can only read/update their own profile
CREATE POLICY "Users can view own profile" ON user_profiles
  FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Users can update own profile" ON user_profiles
  FOR UPDATE USING (auth.uid() = id);
```

### Authentication Middleware
[Source: architecture/11-security-architecture.md#authentication-authorization]

The middleware should follow this pattern:
```typescript
export function withAuth(handler: NextApiHandler): NextApiHandler {
  return async (req, res) => {
    const supabase = createPagesServerClient({ req, res });
    const { data: { user }, error } = await supabase.auth.getUser();
    
    if (error || !user) {
      return res.status(401).json({ error: 'Unauthorized' });
    }
    
    req.user = user;
    return handler(req, res);
  };
}
```

### Client Authentication Setup
Use @supabase/auth-helpers-nextjs for seamless auth integration:
- SessionContextProvider for auth state management
- useUser() hook for accessing current user
- useSupabaseClient() for authenticated requests

### Testing
- Verify Supabase connection with test query
- Test user signup/login flow
- Confirm RLS policies work correctly
- Validate auth persistence across page refreshes

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-17 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_
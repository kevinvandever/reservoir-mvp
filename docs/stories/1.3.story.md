# Story 1.3: Set Up Database Schema

## Status
Ready for Review

## Story
**As a** developer,
**I want** to set up the complete database schema with migrations,
**so that** we have a robust data foundation for all platform features

## Acceptance Criteria
1. All core database tables are created according to schema specification
2. Row Level Security (RLS) policies are configured for all tables
3. Database indexes are added for performance optimization
4. Migration files are created and versioned properly
5. Seed data is available for development and testing
6. Database schema can be reset and recreated reliably
7. All foreign key relationships and constraints are properly configured

## Tasks / Subtasks
- [x] Create user and profile tables (AC: 1, 7)
  - [x] Create user_profiles table with business attributes
  - [x] Add foreign key to auth.users
  - [x] Add check constraints for enum fields
- [x] Set up questionnaire system tables (AC: 1, 7)
  - [x] Create questionnaire_sessions table
  - [x] Create questionnaire_responses table
  - [x] Add proper indexes for session lookups
- [x] Create automation library tables (AC: 1, 7)
  - [x] Create automations table with pgvector extension for embeddings
  - [x] Create automation_tools table
  - [x] Create implementation_steps table
  - [x] Create step_media table
- [x] Set up discovery and recommendation tables (AC: 1, 7)
  - [x] Create weekly_discoveries table
  - [x] Create discovered_automations table
  - [x] Add indexes for date-based queries
- [x] Create user progress tracking tables (AC: 1, 7)
  - [x] Create user_automations table
  - [x] Create automation_progress table
  - [x] Add composite indexes for user queries
- [x] Set up subscription management tables (AC: 1, 7)
  - [x] Create subscriptions table
  - [x] Create usage_metrics table
  - [x] Add Stripe-related fields and indexes
- [x] Configure Row Level Security (AC: 2)
  - [x] Create RLS policies for user-owned data
  - [x] Create admin access policies
  - [x] Test RLS policies with different user roles
- [x] Add performance indexes (AC: 3)
  - [x] Add indexes for foreign key columns
  - [x] Create composite indexes for common queries
  - [x] Add GIN indexes for array fields
- [x] Create migration system (AC: 4)
  - [x] Set up Supabase migration files
  - [x] Create initial schema migration
  - [x] Document migration procedures
- [x] Add seed data (AC: 5)
  - [x] Create sample automations data
  - [x] Add test user profiles
  - [x] Generate sample questionnaire sessions
- [x] Create reset scripts (AC: 6)
  - [x] Create database reset script
  - [x] Add safe guards for production environment
  - [x] Test reset and recreation process

## Dev Notes
### Database Schema Overview
[Source: architecture/8-database-schema.md]

The database uses PostgreSQL via Supabase with the following key features:
- pgvector extension for AI embeddings (1536 dimensions for OpenAI Ada-2)
- JSONB fields for flexible AI context storage
- Comprehensive audit trails with created_at/updated_at timestamps
- Enum constraints for controlled vocabularies

### Core Tables Structure
```sql
-- Enable pgvector extension (run in Supabase SQL editor)
CREATE EXTENSION IF NOT EXISTS vector;

-- Key enums used across tables
business_size: 'solo', 'small-team', 'large-team'
experience: 'beginner', 'intermediate', 'expert'
difficulty: 'easy', 'medium', 'hard'
status variations per table (see schema file)
```

### RLS Policy Patterns
[Source: architecture/11-security-architecture.md]

Standard RLS patterns to implement:
```sql
-- Users can only access their own data
CREATE POLICY "Users can view own data" ON table_name
  FOR SELECT USING (auth.uid() = user_id);

-- Users can update their own data
CREATE POLICY "Users can update own data" ON table_name
  FOR UPDATE USING (auth.uid() = user_id);

-- Public read for published content
CREATE POLICY "Anyone can view published" ON automations
  FOR SELECT USING (published = true);

-- Admin full access (requires user_profiles.role check)
CREATE POLICY "Admins have full access" ON table_name
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM user_profiles
      WHERE user_profiles.user_id = auth.uid()
      AND user_profiles.role = 'admin'
    )
  );
```

### Index Strategy
Key indexes to create:
- Foreign key columns (automatic in PostgreSQL)
- Composite indexes for common queries:
  - (user_id, created_at) for user activity queries
  - (user_id, status) for status filtering
  - (week_of, user_id) for weekly discoveries
- GIN indexes for array fields (tags, current_tools)
- Vector index for embedding similarity search

### Migration File Structure
```
supabase/migrations/
├── 20250817000001_initial_schema.sql
├── 20250817000002_add_rls_policies.sql
├── 20250817000003_add_indexes.sql
└── 20250817000004_seed_data.sql
```

### Testing Requirements
- Verify all tables create successfully
- Test RLS policies with different user contexts
- Confirm foreign key constraints work
- Validate enum constraints
- Test cascade deletes work properly
- Verify indexes improve query performance

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-17 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- TypeScript compilation: ✅ All schema types compile successfully
- Migration files: ✅ 4 migration files created with proper ordering
- Database constraints: ✅ All foreign keys, enums, and check constraints implemented
- RLS policies: ✅ Comprehensive security policies for all tables

### Completion Notes List
- Created comprehensive database schema with 13 core tables
- Implemented all required PostgreSQL enums for controlled vocabularies
- Set up pgvector extension for AI embeddings (1536 dimensions for OpenAI)
- Created comprehensive RLS policies for user data protection and admin access
- Added 50+ performance indexes including GIN indexes for arrays and vector similarity
- Built complete migration system with versioned SQL files
- Generated rich seed data with 5 sample automations and test user data
- Created database reset script with production safeguards
- Updated TypeScript types to match complete database schema
- Fixed auth context to work with new user profile fields
- All tables include proper audit trails with created_at/updated_at timestamps

### File List
**Created:**
- supabase/migrations/20250817000001_initial_schema.sql - Complete database schema
- supabase/migrations/20250817000002_add_rls_policies.sql - Row Level Security policies
- supabase/migrations/20250817000003_add_indexes.sql - Performance indexes
- supabase/migrations/20250817000004_seed_data.sql - Sample data for testing
- scripts/reset-database.sql - Database reset script with safeguards
- scripts/run-migrations.sh - Migration management script

**Modified:**
- lib/supabase/types.ts - Complete TypeScript database types for all tables
- lib/auth/context.tsx - Updated to work with new user profile schema
- lib/supabase/auth-helpers.ts - Updated signup function signature

## QA Results
_To be filled by QA agent_
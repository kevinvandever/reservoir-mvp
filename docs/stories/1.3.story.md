# Story 1.3: Set Up Database Schema

## Status
Approved

## Story
**As a** developer,
**I want** to set up the complete database schema with migrations,
**so that** we have a robust data foundation for all platform features

## Acceptance Criteria
1. All core database tables are created according to schema specification
2. Row Level Security (RLS) policies are configured for all tables
3. Database indexes are added for performance optimization
4. Migration files are created and versioned properly
5. Seed data is available for development and testing
6. Database schema can be reset and recreated reliably
7. All foreign key relationships and constraints are properly configured

## Tasks / Subtasks
- [ ] Create user and profile tables (AC: 1, 7)
  - [ ] Create user_profiles table with business attributes
  - [ ] Add foreign key to auth.users
  - [ ] Add check constraints for enum fields
- [ ] Set up questionnaire system tables (AC: 1, 7)
  - [ ] Create questionnaire_sessions table
  - [ ] Create questionnaire_responses table
  - [ ] Add proper indexes for session lookups
- [ ] Create automation library tables (AC: 1, 7)
  - [ ] Create automations table with pgvector extension for embeddings
  - [ ] Create automation_tools table
  - [ ] Create implementation_steps table
  - [ ] Create step_media table
- [ ] Set up discovery and recommendation tables (AC: 1, 7)
  - [ ] Create weekly_discoveries table
  - [ ] Create discovered_automations table
  - [ ] Add indexes for date-based queries
- [ ] Create user progress tracking tables (AC: 1, 7)
  - [ ] Create user_automations table
  - [ ] Create automation_progress table
  - [ ] Add composite indexes for user queries
- [ ] Set up subscription management tables (AC: 1, 7)
  - [ ] Create subscriptions table
  - [ ] Create usage_metrics table
  - [ ] Add Stripe-related fields and indexes
- [ ] Configure Row Level Security (AC: 2)
  - [ ] Create RLS policies for user-owned data
  - [ ] Create admin access policies
  - [ ] Test RLS policies with different user roles
- [ ] Add performance indexes (AC: 3)
  - [ ] Add indexes for foreign key columns
  - [ ] Create composite indexes for common queries
  - [ ] Add GIN indexes for array fields
- [ ] Create migration system (AC: 4)
  - [ ] Set up Supabase migration files
  - [ ] Create initial schema migration
  - [ ] Document migration procedures
- [ ] Add seed data (AC: 5)
  - [ ] Create sample automations data
  - [ ] Add test user profiles
  - [ ] Generate sample questionnaire sessions
- [ ] Create reset scripts (AC: 6)
  - [ ] Create database reset script
  - [ ] Add safe guards for production environment
  - [ ] Test reset and recreation process

## Dev Notes
### Database Schema Overview
[Source: architecture/8-database-schema.md]

The database uses PostgreSQL via Supabase with the following key features:
- pgvector extension for AI embeddings (1536 dimensions for OpenAI Ada-2)
- JSONB fields for flexible AI context storage
- Comprehensive audit trails with created_at/updated_at timestamps
- Enum constraints for controlled vocabularies

### Core Tables Structure
```sql
-- Enable pgvector extension (run in Supabase SQL editor)
CREATE EXTENSION IF NOT EXISTS vector;

-- Key enums used across tables
business_size: 'solo', 'small-team', 'large-team'
experience: 'beginner', 'intermediate', 'expert'
difficulty: 'easy', 'medium', 'hard'
status variations per table (see schema file)
```

### RLS Policy Patterns
[Source: architecture/11-security-architecture.md]

Standard RLS patterns to implement:
```sql
-- Users can only access their own data
CREATE POLICY "Users can view own data" ON table_name
  FOR SELECT USING (auth.uid() = user_id);

-- Users can update their own data
CREATE POLICY "Users can update own data" ON table_name
  FOR UPDATE USING (auth.uid() = user_id);

-- Public read for published content
CREATE POLICY "Anyone can view published" ON automations
  FOR SELECT USING (published = true);

-- Admin full access (requires user_profiles.role check)
CREATE POLICY "Admins have full access" ON table_name
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM user_profiles
      WHERE user_profiles.user_id = auth.uid()
      AND user_profiles.role = 'admin'
    )
  );
```

### Index Strategy
Key indexes to create:
- Foreign key columns (automatic in PostgreSQL)
- Composite indexes for common queries:
  - (user_id, created_at) for user activity queries
  - (user_id, status) for status filtering
  - (week_of, user_id) for weekly discoveries
- GIN indexes for array fields (tags, current_tools)
- Vector index for embedding similarity search

### Migration File Structure
```
supabase/migrations/
├── 20250817000001_initial_schema.sql
├── 20250817000002_add_rls_policies.sql
├── 20250817000003_add_indexes.sql
└── 20250817000004_seed_data.sql
```

### Testing Requirements
- Verify all tables create successfully
- Test RLS policies with different user contexts
- Confirm foreign key constraints work
- Validate enum constraints
- Test cascade deletes work properly
- Verify indexes improve query performance

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-17 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_
# Story 1.5: Set Up Deployment Pipeline

## Status
Approved

## Story
**As a** developer,
**I want** to set up automated deployment pipeline with Netlify,
**so that** we have continuous deployment from Git commits to production

## Acceptance Criteria
1. Netlify project is connected to Git repository
2. Build and deployment settings are configured
3. Environment variables are configured in Netlify
4. Preview deployments work for pull requests
5. Custom domain is configured (if available)
6. Build optimizations are implemented
7. Deployment notifications are set up

## Tasks / Subtasks
- [ ] Set up Netlify project (AC: 1)
  - [ ] Create Netlify account/project
  - [ ] Connect to Git repository (GitHub/GitLab)
  - [ ] Configure branch deployments (main = production)
- [ ] Configure build settings (AC: 2)
  - [ ] Set build command: `npm run build`
  - [ ] Set publish directory: `.next`
  - [ ] Configure Next.js adapter for Netlify
  - [ ] Add netlify.toml configuration file
- [ ] Set up environment variables (AC: 3)
  - [ ] Add production Supabase credentials
  - [ ] Add OpenAI API key (for future use)
  - [ ] Configure NEXT_PUBLIC_APP_URL
  - [ ] Set NODE_VERSION for consistency
- [ ] Configure preview deployments (AC: 4)
  - [ ] Enable deploy previews for PRs
  - [ ] Set up branch deploys for staging
  - [ ] Configure preview environment variables
- [ ] Set up domain configuration (AC: 5)
  - [ ] Add custom domain (if available)
  - [ ] Configure SSL certificate
  - [ ] Set up domain redirects if needed
- [ ] Implement build optimizations (AC: 6)
  - [ ] Configure edge functions for API routes
  - [ ] Set up image optimization
  - [ ] Enable build caching
  - [ ] Configure ISR (Incremental Static Regeneration)
- [ ] Configure notifications (AC: 7)
  - [ ] Set up deploy notifications (email/Slack)
  - [ ] Configure build failure alerts
  - [ ] Add deploy status badge to README

## Dev Notes
### Netlify Configuration
[Source: architecture/15-deployment-architecture.md#netlify-configuration]

Create netlify.toml in project root:
```toml
[build]
  command = "npm run build"
  publish = ".next"

[build.environment]
  NODE_VERSION = "18"
  NEXT_TELEMETRY_DISABLED = "1"

[[plugins]]
  package = "@netlify/plugin-nextjs"

[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/:splat"
  status = 200

[functions]
  directory = "netlify/functions"
  node_bundler = "esbuild"

[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    X-XSS-Protection = "1; mode=block"
    Referrer-Policy = "strict-origin-when-cross-origin"
```

### Environment Variables for Production
Required environment variables to set in Netlify dashboard:
```bash
# Supabase Production
NEXT_PUBLIC_SUPABASE_URL=<production_url>
NEXT_PUBLIC_SUPABASE_ANON_KEY=<production_anon_key>
SUPABASE_SERVICE_ROLE_KEY=<production_service_key>

# OpenAI (for future use)
OPENAI_API_KEY=<your_api_key>

# App Configuration
NEXT_PUBLIC_APP_URL=https://your-domain.com
NEXT_PUBLIC_ENV=production

# Monitoring (optional)
SENTRY_DSN=<sentry_dsn>
VERCEL_ANALYTICS_ID=<analytics_id>
```

### Next.js Netlify Adapter
Install and configure @netlify/plugin-nextjs:
```bash
npm install -D @netlify/plugin-nextjs
```

Update next.config.js:
```javascript
module.exports = {
  target: 'serverless',
  images: {
    domains: ['your-supabase-url.supabase.co'],
  },
}
```

### Build Optimization Settings
- Enable build caching for node_modules
- Use Netlify Edge Functions for API routes
- Configure ISR for dynamic pages
- Set up proper cache headers

### Preview Deployment Strategy
- Main branch → Production
- Develop branch → Staging environment
- Feature branches → Preview deployments
- Each PR gets unique preview URL

### Deployment Checklist
Before first deployment:
1. Verify all environment variables are set
2. Test build command locally
3. Ensure .env files are in .gitignore
4. Check that database migrations are applied
5. Verify API routes work with edge functions

### Monitoring
[Source: architecture/17-success-metrics-kpis.md]
- Set up Netlify Analytics for traffic monitoring
- Configure Sentry for error tracking
- Add performance monitoring with Web Vitals

### Testing
- Verify production build succeeds
- Test preview deployments work
- Confirm environment variables are accessible
- Check API routes function correctly
- Validate SSL certificate is active

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-17 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_
# Story 2.12: Mobile Navigation & PWA Features

## Status
Draft

## Story
As a mobile user,
I want native app-like navigation and offline capabilities,
So that I can access automations anywhere, anytime

## Acceptance Criteria

1. Bottom tab navigation for core sections
2. PWA installation prompts appear appropriately
3. Offline mode displays cached content gracefully
4. Pull-to-refresh functionality updates discovery feed
5. Touch gestures for common actions (swipe to dismiss)
6. Native-feeling transitions and animations
7. Push notifications for new discoveries
8. App-like loading and splash screens

## Tasks / Subtasks

• **Set up PWA infrastructure** (AC 2, 7, 8)
  - Configure service worker for caching
  - Set up PWA manifest file
  - Implement app installation detection
  - Add PWA installation prompts

• **Build bottom tab navigation** (AC 1)
  - Create bottom tab navigation component
  - Implement tab switching logic
  - Add active state indicators
  - Include proper accessibility support

• **Implement offline functionality** (AC 3)
  - Set up offline data caching strategy
  - Create offline indicator UI
  - Implement graceful offline degradation
  - Add offline content synchronization

• **Add pull-to-refresh functionality** (AC 4)
  - Implement pull-to-refresh gesture
  - Create refresh animations
  - Add refresh state management
  - Include haptic feedback for iOS

• **Build touch gesture system** (AC 5)
  - Implement swipe to dismiss gestures
  - Add touch-friendly interaction zones
  - Create gesture feedback animations
  - Include gesture accessibility alternatives

• **Create native-feeling transitions** (AC 6)
  - Implement page transition animations
  - Add loading state transitions
  - Create smooth navigation animations
  - Include proper performance optimization

• **Set up push notifications** (AC 7)
  - Configure push notification service
  - Implement notification permission requests
  - Create notification templates
  - Add notification click handling

• **Build app-like loading experience** (AC 8)
  - Create splash screen component
  - Implement app-like loading states
  - Add progressive loading animations
  - Include proper loading error handling

• **Optimize mobile performance** (AC 1-8)
  - Implement lazy loading for mobile
  - Optimize touch response times
  - Add proper viewport configuration
  - Test performance across devices

• **Testing and validation** (AC 1-8)
  - Test PWA installation across browsers
  - Validate offline functionality
  - Test notification delivery and engagement
  - Performance testing on various mobile devices

## Dev Notes

### Tech Stack Requirements
- **Framework**: Next.js 14.x with App Router for mobile-optimized routing
- **Language**: TypeScript 5.x for type-safe PWA configuration
- **Styling**: Tailwind CSS 3.x with mobile-first responsive design
- **UI Components**: shadcn/ui components optimized for mobile touch interactions
- **State Management**: Zustand for offline state management and sync
- **Database**: Supabase for offline-capable data synchronization
- **PWA Tools**: Next.js PWA plugin, Workbox for service worker management
- **Push Notifications**: Web Push API with Supabase real-time subscriptions
- **Testing**: Jest + React Testing Library for PWA functionality testing

### Component Architecture
Following `/src/components/` structure:
- `/src/components/mobile/` - Mobile-specific components
  - `BottomTabNavigation.tsx` - Primary mobile navigation
  - `PWAInstallPrompt.tsx` - Installation banner component
  - `OfflineIndicator.tsx` - Network status indicator
  - `PullToRefresh.tsx` - Pull-to-refresh gesture handler
  - `TouchGestureHandler.tsx` - Swipe and touch gesture system
  - `SplashScreen.tsx` - App loading screen
- `/src/components/ui/` - Enhanced mobile UI components
  - Extended Button, Card, Input components with touch optimization
- `/src/lib/services/` - PWA service layer
  - `pwa.ts` - PWA installation and management
  - `serviceWorker.ts` - Offline caching strategies
  - `notifications.ts` - Push notification handling
  - `gestures.ts` - Touch gesture recognition
- `/src/stores/` - Mobile state management
  - `mobileStore.ts` - Mobile UI state (tab navigation, gestures)
  - `offlineStore.ts` - Offline data and synchronization
  - `notificationStore.ts` - Push notification management

### Technical Implementation

**PWA Configuration**:
```typescript
// next.config.js PWA setup
const withPWA = require('next-pwa')({
  dest: 'public',
  register: true,
  skipWaiting: true,
  runtimeCaching: [
    {
      urlPattern: /^https:\/\/fonts\.googleapis\.com\/.*/i,
      handler: 'CacheFirst',
      options: {
        cacheName: 'google-fonts',
        expiration: {
          maxEntries: 4,
          maxAgeSeconds: 365 * 24 * 60 * 60 // 1 year
        }
      }
    },
    {
      urlPattern: /^\/api\/(discoveries|automations)\/.*/i,
      handler: 'NetworkFirst',
      options: {
        cacheName: 'api-cache',
        networkTimeoutSeconds: 10,
        expiration: {
          maxEntries: 100,
          maxAgeSeconds: 24 * 60 * 60 // 1 day
        }
      }
    }
  ]
});
```

**Bottom Tab Navigation**:
```typescript
// Mobile navigation with proper touch targets (44px minimum)
const BottomTabNavigation = () => {
  const { activeTab, setActiveTab } = useMobileStore();
  
  const tabs = [
    { id: 'discoveries', icon: SearchIcon, label: 'Discover' },
    { id: 'dashboard', icon: HomeIcon, label: 'Dashboard' },
    { id: 'progress', icon: TrendingUpIcon, label: 'Progress' },
    { id: 'profile', icon: UserIcon, label: 'Profile' }
  ];
  
  return (
    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 safe-area-inset-bottom">
      <div className="flex">
        {tabs.map(tab => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id)}
            className="flex-1 py-2 px-1 min-h-12 flex flex-col items-center justify-center"
            aria-label={tab.label}
          >
            <tab.icon className={`w-6 h-6 ${activeTab === tab.id ? 'text-blue-600' : 'text-gray-400'}`} />
            <span className={`text-xs mt-1 ${activeTab === tab.id ? 'text-blue-600' : 'text-gray-400'}`}>
              {tab.label}
            </span>
          </button>
        ))}
      </div>
    </nav>
  );
};
```

**Offline Functionality**:
```typescript
// Offline data synchronization strategy
export class OfflineService {
  private db: IDBDatabase;
  
  async cacheDiscoveries(discoveries: WeeklyDiscovery[]) {
    const transaction = this.db.transaction(['discoveries'], 'readwrite');
    const store = transaction.objectStore('discoveries');
    
    for (const discovery of discoveries) {
      await store.put(discovery);
    }
  }
  
  async getOfflineDiscoveries(): Promise<WeeklyDiscovery[]> {
    if (!navigator.onLine) {
      const transaction = this.db.transaction(['discoveries'], 'readonly');
      const store = transaction.objectStore('discoveries');
      return await store.getAll();
    }
    return [];
  }
  
  async syncWhenOnline() {
    if (navigator.onLine) {
      const pendingActions = await this.getPendingActions();
      for (const action of pendingActions) {
        await this.executeAction(action);
      }
    }
  }
}
```

**Touch Gesture System**:
```typescript
// React hook for touch gestures
export const useSwipeGesture = (
  ref: RefObject<HTMLElement>,
  onSwipeLeft?: () => void,
  onSwipeRight?: () => void
) => {
  useEffect(() => {
    const element = ref.current;
    if (!element) return;
    
    let startX = 0;
    let startY = 0;
    
    const handleTouchStart = (e: TouchEvent) => {
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
    };
    
    const handleTouchEnd = (e: TouchEvent) => {
      const endX = e.changedTouches[0].clientX;
      const endY = e.changedTouches[0].clientY;
      
      const deltaX = endX - startX;
      const deltaY = endY - startY;
      
      // Minimum swipe distance and ensure horizontal swipe
      if (Math.abs(deltaX) > 50 && Math.abs(deltaX) > Math.abs(deltaY)) {
        if (deltaX > 0 && onSwipeRight) {
          onSwipeRight();
        } else if (deltaX < 0 && onSwipeLeft) {
          onSwipeLeft();
        }
      }
    };
    
    element.addEventListener('touchstart', handleTouchStart);
    element.addEventListener('touchend', handleTouchEnd);
    
    return () => {
      element.removeEventListener('touchstart', handleTouchStart);
      element.removeEventListener('touchend', handleTouchEnd);
    };
  }, [ref, onSwipeLeft, onSwipeRight]);
};
```

### File Structure
```
src/
├── components/mobile/
│   ├── BottomTabNavigation.tsx
│   ├── PWAInstallPrompt.tsx
│   ├── OfflineIndicator.tsx
│   ├── PullToRefresh.tsx
│   ├── TouchGestureHandler.tsx
│   └── SplashScreen.tsx
├── lib/services/
│   ├── pwa.ts
│   ├── serviceWorker.ts
│   ├── notifications.ts
│   └── gestures.ts
├── stores/
│   ├── mobileStore.ts
│   ├── offlineStore.ts
│   └── notificationStore.ts
├── hooks/
│   ├── usePWA.ts
│   ├── useOffline.ts
│   ├── useSwipeGesture.ts
│   └── usePushNotifications.ts
└── types/
    ├── mobile.ts
    ├── pwa.ts
    └── notifications.ts
```

### Testing Requirements
- **Unit Tests**: PWA service worker functionality, offline data synchronization
- **Integration Tests**: Mobile navigation flows, gesture recognition accuracy
- **E2E Tests**: Full PWA installation and offline usage scenarios
- **Device Testing**: iOS Safari, Android Chrome, various viewport sizes
- **Performance Tests**: Touch response times (<100ms), animation frame rates (60fps)
- **Accessibility Tests**: Screen reader compatibility with mobile navigation

### Performance Considerations
- Service worker caching strategy for 90% cache hit rate on repeat visits
- Touch event debouncing to prevent gesture conflicts
- Lazy loading of non-critical mobile components
- Image optimization for mobile bandwidth constraints
- Battery-efficient background sync strategies

## Change Log

### 2024-12-19 - Story Standardization
- Converted to standard template format
- Added comprehensive Dev Notes with technical architecture
- Restructured Tasks/Subtasks with AC references
- Added detailed component architecture and implementation examples
- Included mobile-specific testing strategy and performance requirements

## Dev Agent Record

### Planning Phase
- [ ] Review mobile UX documentation and PWA specifications
- [ ] Analyze current component architecture for mobile optimization needs
- [ ] Define service worker caching strategies for offline functionality
- [ ] Plan push notification integration with backend services

### Implementation Phase
- [ ] PWA infrastructure setup and service worker configuration
- [ ] Bottom tab navigation component development
- [ ] Offline functionality and data synchronization implementation
- [ ] Touch gesture system and pull-to-refresh features
- [ ] Push notification setup and native app experience

### Testing Phase
- [ ] PWA installation testing across browsers and devices
- [ ] Offline functionality validation and performance testing
- [ ] Mobile navigation and gesture testing
- [ ] Push notification delivery and engagement testing

### Deployment Phase
- [ ] Service worker deployment and cache invalidation strategy
- [ ] Mobile-specific performance monitoring setup
- [ ] PWA analytics and installation tracking
- [ ] Post-deployment mobile experience validation

## QA Results

### Functionality Testing
- [ ] PWA installation process works across all supported browsers
- [ ] Offline mode gracefully handles network disconnections
- [ ] Bottom tab navigation maintains state during app usage
- [ ] Touch gestures respond accurately without conflicts
- [ ] Push notifications deliver and display correctly

### Performance Testing
- [ ] Touch response times consistently under 100ms
- [ ] App loading time under 3 seconds on 3G connections
- [ ] Smooth 60fps animations during transitions
- [ ] Battery usage optimization for background features

### Accessibility Testing
- [ ] Screen reader compatibility with mobile navigation
- [ ] Keyboard navigation alternative for touch gestures
- [ ] Sufficient touch target sizes (minimum 44px)
- [ ] Color contrast compliance in mobile interface

### Cross-Device Testing
- [ ] iOS Safari PWA installation and functionality
- [ ] Android Chrome PWA installation and functionality
- [ ] Responsive design across mobile viewport sizes
- [ ] Feature parity between mobile web and PWA modes
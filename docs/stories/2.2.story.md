# Story 2.2: Implement OpenAI Integration

## Status
Approved

## Story
**As a** developer,
**I want** to integrate OpenAI API for questionnaire intelligence,
**so that** the system can conduct adaptive, intelligent conversations with users

## Acceptance Criteria
1. OpenAI API client is configured with proper error handling
2. Adaptive question generation works based on user responses
3. Context is maintained throughout the conversation
4. Rate limiting and cost controls are implemented
5. Responses are validated and sanitized before display
6. Fallback questions exist if API fails
7. Token usage is tracked and optimized
8. System prompts guide appropriate business discovery

## Tasks / Subtasks
- [ ] Set up OpenAI client (AC: 1)
  - [ ] Install OpenAI SDK
  - [ ] Create lib/openai/client.ts with configuration
  - [ ] Add API key to environment variables
  - [ ] Implement retry logic for failed requests
- [ ] Create questionnaire AI service (AC: 2, 3, 8)
  - [ ] Build QuestionnaireAI class with methods
  - [ ] Implement generateNextQuestion method
  - [ ] Create conversation context management
  - [ ] Design system prompts for business discovery
- [ ] Implement adaptive questioning logic (AC: 2, 3)
  - [ ] Create question flow state machine
  - [ ] Build response analysis for branching
  - [ ] Implement follow-up question generation
  - [ ] Add question category tracking
- [ ] Add rate limiting and cost controls (AC: 4, 7)
  - [ ] Implement request rate limiting (10/min)
  - [ ] Add daily/monthly cost tracking
  - [ ] Create token usage optimization
  - [ ] Set max tokens per request (500)
- [ ] Implement response processing (AC: 5)
  - [ ] Sanitize AI responses for display
  - [ ] Validate response format
  - [ ] Extract structured data from responses
  - [ ] Handle incomplete or invalid responses
- [ ] Create fallback system (AC: 6)
  - [ ] Build static question bank
  - [ ] Implement fallback logic when API fails
  - [ ] Create offline mode detection
  - [ ] Add graceful degradation
- [ ] Build API route handlers (AC: 1, 2)
  - [ ] Create /api/questionnaire/next-question
  - [ ] Add /api/questionnaire/analyze-response
  - [ ] Implement session context passing
  - [ ] Add proper error responses
- [ ] Add monitoring and logging (AC: 7)
  - [ ] Log token usage per request
  - [ ] Track API response times
  - [ ] Monitor error rates
  - [ ] Create usage dashboard data

## Dev Notes
### OpenAI Configuration
[Source: architecture/6-external-api-integrations.md#openai-integration]

```typescript
// lib/openai/client.ts
import OpenAI from 'openai';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
  maxRetries: 3,
  timeout: 30000,
});

// Cost management
const MAX_TOKENS_PER_REQUEST = 500;
const MAX_DAILY_SPEND = 20; // $20
const MAX_MONTHLY_SPEND = 500; // $500
```

### Questionnaire AI Service
[Source: architecture/6-external-api-integrations.md#openai-integration]

```typescript
class QuestionnaireAI {
  private systemPrompt = `You are an expert business consultant specializing in 
    real estate automation. Conduct a discovery conversation to understand the 
    user's business, pain points, and automation opportunities. Ask one question 
    at a time, make it conversational, and adapt based on their responses.`;

  async generateNextQuestion(context: QuestionContext): Promise<Question> {
    // Use GPT-4 Turbo for intelligent questioning
    const completion = await openai.chat.completions.create({
      model: 'gpt-4-turbo-preview',
      messages: [
        { role: 'system', content: this.systemPrompt },
        ...context.conversationHistory,
        { role: 'user', content: context.lastResponse }
      ],
      max_tokens: MAX_TOKENS_PER_REQUEST,
      temperature: 0.7,
    });
    
    return this.parseQuestion(completion.choices[0].message);
  }
}
```

### Question Categories
Categories to track for adaptive flow:
- Business Overview (size, type, location)
- Current Tools & Tech Stack
- Pain Points & Challenges
- Goals & Objectives
- Time Management
- Client Management
- Marketing & Lead Generation
- Transaction Management

### Rate Limiting
[Source: architecture/11-security-architecture.md#data-protection]

```typescript
const rateLimiter = {
  windowMs: 60000, // 1 minute
  maxRequests: 10,
  costTracking: true,
  maxDailySpend: 20,
};
```

### Fallback Questions Bank
Store in database or constants file:
```typescript
const FALLBACK_QUESTIONS = {
  'business-overview': [
    "How would you describe your real estate business?",
    "How many transactions do you typically handle per year?",
  ],
  'pain-points': [
    "What tasks take up most of your time each day?",
    "What's your biggest challenge in growing your business?",
  ],
  // ... more categories
};
```

### API Routes Structure
```
app/api/questionnaire/
├── next-question/
│   └── route.ts       # POST: Get next question
├── analyze-response/
│   └── route.ts       # POST: Analyze user response
└── complete/
    └── route.ts       # POST: Complete questionnaire
```

### Testing
- Mock OpenAI responses for unit tests
- Test rate limiting works correctly
- Verify fallback questions activate on API failure
- Test token usage stays within limits
- Validate response sanitization
- Check context maintains across questions

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-17 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_
# Story 2.5: Develop Discovery Feed & Personalization Engine

## Status
Draft

## Story
**As a** subscribed user,
**I want** to receive personalized weekly automation discoveries,
**so that** I can continuously discover relevant automations for my business

## Acceptance Criteria
1. Weekly discovery generation creates personalized recommendations
2. Dashboard displays current week's discoveries with filtering
3. Personalization engine matches automations to user profile
4. Users can save, dismiss, or mark automations as implemented
5. Discovery cards show impact metrics and difficulty
6. Search and filtering work across all discoveries
7. Email notifications are sent when new discoveries available
8. User preferences control discovery frequency and categories

## Tasks / Subtasks
- [ ] Build personalization engine (AC: 1, 3)
  - [ ] Create PersonalizationEngine class
  - [ ] Implement user profile analysis
  - [ ] Build automation matching algorithm
  - [ ] Generate relevance scores for recommendations
- [ ] Create weekly discovery generation (AC: 1)
  - [ ] Build scheduled job for discovery generation
  - [ ] Create discovery service with AI enhancement
  - [ ] Implement batch processing for all users
  - [ ] Add discovery deduplication logic
- [ ] Build discovery dashboard (AC: 2, 6)
  - [ ] Create /dashboard route
  - [ ] Build DiscoveryFeed component
  - [ ] Add search and filter functionality
  - [ ] Implement infinite scroll for large lists
- [ ] Create discovery cards (AC: 4, 5)
  - [ ] Build DiscoveryCard component
  - [ ] Add save/dismiss/implement actions
  - [ ] Display impact metrics and difficulty
  - [ ] Show personalized reasoning
- [ ] Implement user actions (AC: 4)
  - [ ] Create save automation functionality
  - [ ] Add dismiss with feedback
  - [ ] Build implementation tracking
  - [ ] Update user progress metrics
- [ ] Add filtering and search (AC: 6)
  - [ ] Create filter component (category, difficulty, time impact)
  - [ ] Implement full-text search
  - [ ] Add sorting options (relevance, impact, date)
  - [ ] Save user filter preferences
- [ ] Build email notifications (AC: 7)
  - [ ] Create weekly discovery email template
  - [ ] Implement email sending service
  - [ ] Add unsubscribe functionality
  - [ ] Track email engagement metrics
- [ ] Add user preferences (AC: 8)
  - [ ] Create preferences UI
  - [ ] Add frequency control (weekly, biweekly, monthly)
  - [ ] Category preference selection
  - [ ] Difficulty level preferences

## Dev Notes
### Personalization Algorithm
[Source: architecture/6-external-api-integrations.md#personalization-engine]

```typescript
class PersonalizationEngine {
  async generateWeeklyDiscoveries(userId: string): Promise<Discovery[]> {
    const userProfile = await this.getUserProfile(userId);
    const previousDiscoveries = await this.getPreviousDiscoveries(userId);
    const automations = await this.getEligibleAutomations(userProfile);
    
    // Score automations based on relevance
    const scoredAutomations = await this.scoreAutomations(
      automations, 
      userProfile, 
      previousDiscoveries
    );
    
    // Select top 8-12 discoveries
    return this.selectDiscoveries(scoredAutomations, 10);
  }

  private async scoreAutomations(automations, profile, previous) {
    return automations.map(automation => ({
      ...automation,
      relevanceScore: this.calculateRelevance(automation, profile),
      freshness: this.calculateFreshness(automation, previous),
      personalizedReason: this.generateReason(automation, profile)
    }));
  }
}
```

### Database Schema Usage
[Source: architecture/8-database-schema.md]

Uses these tables:
- `weekly_discoveries`: Generated discovery batches
- `discovered_automations`: Individual recommendations
- `user_automations`: User actions on discoveries
- `automations`: Source automation library

### Discovery Feed Structure
[Source: frontend/4-reservoir-dashboard.md]

```typescript
interface Discovery {
  id: string;
  automationId: string;
  userId: string;
  weekOf: Date;
  relevanceScore: number;
  personalizedReason: string;
  status: 'new' | 'saved' | 'dismissed' | 'implemented';
  automation: {
    title: string;
    description: string;
    difficulty: string;
    timeSaved: number;
    revenueImpact: number;
    category: string;
  };
}
```

### Dashboard Components
```
components/dashboard/
├── DiscoveryFeed.tsx      # Main feed container
├── DiscoveryCard.tsx      # Individual discovery
├── DiscoveryHeader.tsx    # Week header with stats
├── FilterPanel.tsx        # Search and filters
├── QuickActions.tsx       # Save/dismiss buttons
├── ProgressWidget.tsx     # User metrics summary
└── PreferencesModal.tsx   # Settings modal
```

### Scheduled Discovery Generation
```typescript
// API route: /api/cron/generate-discoveries
export async function POST() {
  const activeUsers = await getActiveSubscribers();
  
  for (const user of activeUsers) {
    await generateWeeklyDiscoveries(user.id);
  }
  
  // Send notification emails
  await sendDiscoveryNotifications();
}
```

### Email Notifications
[Source: architecture/6-external-api-integrations.md]

Use Resend API for transactional emails:
```typescript
const sendWeeklyDiscovery = async (user: User, discoveries: Discovery[]) => {
  await resend.emails.send({
    from: 'discoveries@reservoir.app',
    to: user.email,
    subject: `${discoveries.length} new automations curated for you`,
    html: DiscoveryEmailTemplate({ user, discoveries })
  });
};
```

### User Actions API
```typescript
// /api/discoveries/[id]/action
export async function POST(request, { params }) {
  const { action } = await request.json(); // 'save' | 'dismiss' | 'implement'
  
  await updateDiscoveryStatus(params.id, action);
  await updateUserProgress(userId, action);
  
  return Response.json({ success: true });
}
```

### Filtering Implementation
```typescript
const filterDiscoveries = (discoveries: Discovery[], filters: FilterState) => {
  return discoveries.filter(discovery => {
    if (filters.category && discovery.automation.category !== filters.category) {
      return false;
    }
    if (filters.difficulty && discovery.automation.difficulty !== filters.difficulty) {
      return false;
    }
    if (filters.minTimeSaved && discovery.automation.timeSaved < filters.minTimeSaved) {
      return false;
    }
    return true;
  });
};
```

### Mobile Optimization
[Source: frontend/4-reservoir-dashboard.md#mobile-dashboard-layout]
- Cards stack vertically on mobile
- Touch-friendly action buttons
- Swipe gestures for save/dismiss
- Progressive loading for performance

### Testing
- Test personalization algorithm accuracy
- Verify weekly generation runs correctly
- Test all user actions (save/dismiss/implement)
- Check email notifications send properly
- Validate filtering and search
- Test mobile responsiveness

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-17 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_